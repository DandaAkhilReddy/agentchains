name: Build & Deploy to Azure

on:
  push:
    branches: [main]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/requirements.txt
      - run: pip install -r requirements.txt
      - run: pytest -v --tb=short

  test-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - run: npm test

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name loanalyzeracr

      - name: Build and push backend image
        run: |
          docker build -t loanalyzeracr.azurecr.io/loan-analyzer-backend:${{ github.sha }} \
                        -t loanalyzeracr.azurecr.io/loan-analyzer-backend:latest \
                        ./backend
          docker push loanalyzeracr.azurecr.io/loan-analyzer-backend --all-tags

      - name: Build and push frontend image
        run: |
          docker build \
            --build-arg VITE_API_BASE_URL="" \
            --build-arg VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }} \
            --build-arg VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }} \
            --build-arg VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }} \
            --build-arg VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }} \
            --build-arg VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }} \
            --build-arg VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }} \
            -t loanalyzeracr.azurecr.io/loan-analyzer-frontend:${{ github.sha }} \
            -t loanalyzeracr.azurecr.io/loan-analyzer-frontend:latest \
            ./frontend
          docker push loanalyzeracr.azurecr.io/loan-analyzer-frontend --all-tags

      - name: Deploy backend to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: app-loan-analyzer-api
          images: loanalyzeracr.azurecr.io/loan-analyzer-backend:${{ github.sha }}

      - name: Deploy frontend to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: app-loan-analyzer-web
          images: loanalyzeracr.azurecr.io/loan-analyzer-frontend:${{ github.sha }}

      - name: Smoke test backend
        run: |
          echo "Waiting 30s for containers to start..."
          sleep 30
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://app-loan-analyzer-api.azurewebsites.net/api/health)
            if [ "$STATUS" = "200" ]; then
              echo "Backend healthy (attempt $i)"
              exit 0
            fi
            echo "Attempt $i: status $STATUS, retrying in 15s..."
            sleep 15
          done
          echo "Backend health check failed after 5 attempts"
          exit 1

      - name: Smoke test frontend
        run: |
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://app-loan-analyzer-web.azurewebsites.net/)
            if [ "$STATUS" = "200" ]; then
              echo "Frontend healthy (attempt $i)"
              exit 0
            fi
            echo "Attempt $i: status $STATUS, retrying in 15s..."
            sleep 15
          done
          echo "Frontend health check failed after 5 attempts"
          exit 1
